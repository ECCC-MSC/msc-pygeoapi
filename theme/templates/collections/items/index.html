{% extends "_base.html" %}
{% block title %}{{ super() }} {{ data['title'] }} {% endblock %}
{% block crumbs %}{{ super() }}
<li><a href="{{ data['collections_path'] }}">Collections</a></li>
{% for link in data['links'] %}
  {% if link.rel == 'collection' %}
    <li><a href="{{ data['dataset_path'] }}">{{ link['title'] }}</a></li>
    {% set col_title = link['title'] %}
  {% endif %}
{% endfor %}
<li><a href="{{ data['items_path']}}">Items</a></li>
{% endblock %}
{% block extrahead %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
{% endblock %}

{% block body %}
  <section id="collection">
    <h1>{% for l in data['links'] if l.rel == 'collection' %} {{ l['title'] }} {% endfor %}</h1>
    <p>Items in this collection.</p>
  </section>
  <section id="items">
    {% if data['features'] %}
    <div class="row">
      <div class="col-sm-12 col-md-12">
        <div class="row">
          <div class="col-sm-12">
            <div id="items-map"></div>
          </div>
        </div>
      </div>
      <div class="col-sm-12 col-md-12 mrgn-tp-sm">
        <div class="form-inline clearfix" aria-controls="items-table">
          <label class="wb-inv" for="filter-table">Filter table content</label>
          <input
            id="filter-table"
            type="text"
            class="form-control input-sm"
            placeholder="Filter table content"
            v-model="searchText">
          <div class="btn-group btn-group-sm pull-right">
            <button title="Clear column search queries and reset to display the default results" class="btn btn-warning" @click="clearSearch"><span class="glyphicon glyphicon-remove"></span> Clear Search</button>
            <button title="Apply column search queries to the entire collection" class="btn btn-primary" @click="getItemsSorted()"><span class="glyphicon glyphicon-search"></span> Search Collection</button>
          </div>
        </div>
        <div id="items-table-container" :class="{ 'loading-mask': itemsLoading }">
          <table id="items-table" class="table table-striped">
            <thead>
              <tr>
                <th v-for="(th, index) in tableFields"
                  :class="th.colClass">
                  <div class="sortable ellipsis" @click="sortDir(th.key)" :title="th.text">
                    <span v-text="truncate(th.text, 15)"></span>
                    <span
                      v-show="currentSort === th.key"
                      :class="[sortIconClass, 'glyphicon']"></span>
                  </div>
                  <div v-if="th.key !== 'id'">
                    <label class="wb-inv" :for="'search-'+th.key">Search column: [% th.key %]</label>
                    <input type="text" class="form-control input-sm" :id="'search-'+th.key" placeholder="Keyword search" v-model="queryCols[th.key]" @keyup.enter="getItemsSorted()" />
                  </div>
                </th>
              </tr>
              <tr v-if="noJs">
                {% if data.get('uri_field') %}
                <th>{{ data['uri_field'] }}</th>
                {% endif %}
                  <th>id</th>
                  {% if data['title_field'] %}
                    <th>{{ data['title_field'] }}</th>
                  {% endif %}
                  {% for k, v in data['features'][0]['properties'].items() %}
                    {# start with id & title then take first 5 columns for table #}
                    {% if loop.index < 5 and k not in [data['id_field'], data['title_field'], data['uri_field'], 'extent'] %}
                    <th>{{ k }}</th>
                    {% endif %}
                  {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr v-for="(item, index) in items">
                <td v-for="(th, index) in tableFields" v-html="linkToRow(item, th.key, itemsPath)">
                </td>
              </tr>
              {% for ft in data['features'] %}
              <tr v-if="noJs">
                {% if data.get('uri_field') %}
                <td data-label="{{ data.get('uri_field') }}"><a href="{{ ft['properties'].get(data['uri_field'])}}" title="{{ ft['properties'][data['uri_field']] }}">{{ft['properties'][data.get('uri_field')]}}</a></td>
                {% endif %}
                <td data-label="id"><a href="{{ data['items_path']}}/{{ ft.id }}" title="{{ ft.id }}">{{ ft.id | string | truncate( 12 )  }}</a></td>
                {% if data['title_field'] %}
                  <td data-label="name"><a href="{{ data['items_path']}}/{{ ft['id'] }}" title="{{ ft['properties'][data['title_field']] }}">{{ ft['properties'][data['title_field']] | string | truncate( 35 ) }}</a></td>
                {% endif %}
                {% for k, v in ft['properties'].items() %}
                  {% if loop.index < 5 and k not in [data['id_field'], data['title_field'], data['uri_field'], 'extent'] %}
                  <td data-label="{{ k }}">{{ v | string | truncate( 35 ) }}</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

        <nav class="small" aria-live="polite" aria-controls="items-table">
          <div class="row">
            <div class="col-xs-4">
              <div class="form-group">
                <label>Limit: </label>
                <select
                  class="input-sm form-control inline-block"
                  v-model="limit"
                  :disabled="itemsLoading"
                  @change="getItemsSorted()">
                    <option value="10">10</option>
                    <option value="100">100</option>
                    <option value="1000">1000</option>
                    <option value="2000">2000</option>
                </select>
              </div>
            </div>
            <div class="col-xs-8 text-right"><span v-text="showingLimitText"></span></div>
          </div>
          <div class="alert alert-warning">
            <p><small>Warning: Higher limits not recommended</small></p>
          </div>
          <ul class="pagination pagination-sm">
            <li>
              <button class="btn btn-sm btn-default" @click="prevPageItems" rel="prev" :disabled="itemsLoading || currentPage === 1">Previous</button>
            </li>
            <span>Page [% currentPage %] / [% maxPages %]</span>
            <li>
              <button class="btn btn-sm btn-default" @click="nextPageItems" :disabled="itemsLoading || currentPage === maxPages" rel="next">Next</button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    {% else %}
    <div class="row col-sm-12">
        <p>No items</p>
    </div>
    {% endif %}
    </section>
{% endblock %}

{% block extrafoot %}
{% if data['features'] %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script type="module">
      import useItems from '{{ config['server']['url'] }}/static/js/composables/useItems.js?v={{ version }}'
      import useTableFilter from '{{ config['server']['url'] }}/static/js/composables/useTableFilter.js?v={{ version }}'
      import useMap from '{{ config['server']['url'] }}/static/js/composables/useMap.js?v={{ version }}'
      import { createApp, ref, computed, watch, onMounted } from 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.0.7/vue.esm-browser.prod.js'
      
      const app = createApp({
        delimiters: ['[%', '%]'],
        setup() {
          const noJs = ref(false) // progressive enhancement

          // Items handling
          const { items, itemsJson, itemProps, getItems, itemsTotal, itemsLoading,
            currentPage, maxPages, prevPage, nextPage, limit, showingLimitText,
            queryCols, clearQueryCols } = useItems()
          
          // Table columns
          const tableFields = computed(() => {
            const fields = []
            if (typeof itemProps === 'undefined') {
              return []
            }
            itemProps.value.forEach((prop) => {
              fields.push({
                key: prop,
                text: prop,
                colClass: 'col-sm-3'
              })
            })
            return fields
          })
          const keyColumns = computed(() => {
            return tableFields.value.map(field => field.key)
          })

          // Table filtering
          const { searchText, searchTextLowered, truncate,
            currentSort, currentSortDir, sortDir, sortIconClass, filteredRows, linkToRow } = useTableFilter(items, keyColumns, 'id')
          
          // Collection searching
          const clearSearch = function() {
            clearQueryCols()
            searchText.value = ''
            getItemsSorted()
          }
          const getItemsSorted = function() {
            getItems(currentSort.value, currentSortDir.value)
          }
          const prevPageItems = function() {
            prevPage()
            getItemsSorted()
          }
          const nextPageItems = function() {
            nextPage()
            getItemsSorted()
          }

          // Map setup
          const itemsPath = '{{ data['items_path'] }}'
          const tileLayerUrl = '{{ config['server']['map']['url'] }}'
          const tileLayerAttr = '{{ config['server']['map']['attribution'] }}'
          useMap('items-map', itemsJson, itemsPath, tileLayerUrl, tileLayerAttr)

          return {
            tableFields, keyColumns, itemsTotal, itemsLoading,
            items: filteredRows, // don't care for unfiltered
            searchText, searchTextLowered, truncate,
            sortIconClass, sortDir, currentSort, currentSortDir,
            limit, showingLimitText, currentPage, maxPages,
            itemsPath, linkToRow,
            queryCols, clearSearch, getItemsSorted, prevPageItems, nextPageItems
          }
        }
      })
      app.mount('#items')
    </script>
{% endif %}
{% endblock %}
